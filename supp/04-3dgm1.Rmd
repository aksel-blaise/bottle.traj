# Analysis of Caddo bottle morphology

## Load packages + data

```{r load.data, echo = TRUE}
# load packages

# devtools::install_github("combmorphR/combmorph", ref = "Stable", build_vignettes = TRUE)
library(here)
library(geomorph)
library(tidyverse)
library(wesanderson)

# read GM data
source('readmulti.csv.R')
setwd("./data")
filelist <- list.files(pattern = ".csv")
coords <- readmulti.csv(filelist)
setwd("../")

# read qualitative data
qdata <- read.csv("qdata.csv", 
                  header = TRUE, 
                  row.names = 1)
qdata <- qdata[match(dimnames(coords)[[3]],rownames(qdata)),]
```

## Generalized Procrustes Analysis

Landmark data were aligned to a global coordinate system [@RN11622;@RN11623;@RN11563], achieved through generalized Procrustes superimposition [@RN478] performed in R 4.0.2 [@R] using the `geomorph` library v. 3.3.1 [@RN11530;@RN1774]. Procrustes superimposition translates, scales, and rotates the coordinate data to allow for comparisons among objects [@RN11564;@RN478]. The `gebmorph` package uses a partial Procrustes superimposition that projects the aligned specimens into tangent space subsequent to alignment in preparation for the use of multivariate methods that assume linear space [@RN1646;@RN11563]. 

```{r gpa, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# gpa
Y.gpa <- gpagen(coords, 
                PrinAxes = TRUE, 
                ProcD = TRUE, 
                Proj = TRUE, 
                print.progress = FALSE)

# output + consensus configuration coords
Y.gpa

# combmorph data frame
gdf <- geomorph.data.frame(shape = Y.gpa$coords, 
                           size = Y.gpa$Csize,
                           geo = qdata$geo,
                           time = qdata$time,
                           comb = qdata$comb)
```

```{r 3d.gpa, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE, fig.cap="Results of generalized Procrustes analysis."}
# render 3d gpa plot
#plot(Y.gpa)

# gpa plot
knitr::include_graphics('images/gpa3d.png')

# add centroid size to qdata
qdata$csz <- Y.gpa$Csize

# print updated qdata with centroid size
knitr::kable(qdata, 
             align = "lccccc", 
             caption = "Modified attributes included in qdata.")
```

## Principal Components Analysis

Principal components analysis [@RN1746] was used to visualise shape variation among the bottles The shape changes described by each principal axis are commonly visualized using thin-plate spline warping of a reference 3D mesh [@RN1731;@RN479]. 

```{r pca, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# principal components analysis
pca<-gm.prcomp(Y.gpa$coords)
summary(pca)
```

## Define models

### Allometry 

```{r allom.traj, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# general allometry
fit.size <- procD.lm(shape ~ size, 
                     data = gdf, 
                     print.progress = FALSE, 
                     iter = 9999)
```

### Size and shape

```{r def.mod.1, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# allometry - common allometry, different means -> comb
fit.sz.ccomb <- procD.lm(shape ~ size + comb, 
                        data = gdf, 
                        print.progress = FALSE, 
                        iter = 9999)

# allometry - unique allometries -> comb
fit.sz.ucomb <- procD.lm(shape ~ size * comb, 
                        data = gdf, 
                        print.progress = FALSE, 
                        iter = 9999)

# size as a function of comb
fit.size.comb <- procD.lm(size ~ comb, 
                           data = gdf, 
                           print.progress = FALSE, 
                           iter = 9999)

# shape as a function of comb
fit.shape.comb <- procD.lm(shape ~ comb, 
                            data = gdf, 
                            print.progress = FALSE, 
                            iter = 9999)

# trajectory
fit <- procD.lm(shape ~ geo * time,
                data = gdf,
                print.progress = FALSE,
                iter = 9999)
```

## Test Hypothesis

The hypothesis assesses whether Formative/Early and Late/Historic Caddo bottles found north and south of the shape boundary follow different patterns of shape change.

A residual randomization permutation procedure (RRPP; n = 10,000 permutations) was used for all Procrustes ANOVAs [@RN1655;@RN11775], which has higher statistical power and a greater ability to identify patterns in the data should they be present [@RN1719]. To assess whether shape changes with size (allometry), and differs by group (region), Procrustes ANOVAs [@RN1749] were also run that enlist effect-sizes (zscores) computed as standard deviates of the generated sampling distributions [@RN1756]. 

### Boxplot

```{r box1, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE, fig.cap = "Boxplot of centroid size by ."}
# attributes for boxplot
csz <- qdata$csz # centroid size
comb <-  qdata$comb # comb + time

# boxplot of Caddo bottle centroid size by comb (north/south)
csz.comb <- ggplot(qdata, aes(x = comb, y = csz, color = comb)) + 
  geom_boxplot() +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 0.3) +
  scale_colour_manual(values = wes_palette("Moonrise2")) +
  theme(legend.position = "none") +
  labs(x = 'North/South + Formative/Early or Late/Historic?', y = 'Centroid Size')

# render plot
csz.comb
```

### Principal Components Analysis

```{r pca1, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# set plot parameters
pch.gps.comb <- c(15:18)[as.factor(comb)]
col.gps.comb <- wes_palette("Moonrise2")[as.factor(comb)]
col.hull <- c("#C27D38","#798E87","#CCC591","#29211F")

# plot pca by comb
pc.plot1 <- plot(pca, 
                 asp = 1,
                 pch = pch.gps.comb,
                 col = col.gps.comb)
                    shapeHulls(pc.plot1, 
                             groups = comb,
                             group.cols = col.hull)
```

### ANOVA

```{r h1, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# comb
anova(fit.sz.ccomb) # common allometry (comb)

# comb
anova(fit.sz.ucomb) # unique allometry (comb)

# ANOVA: do Caddo bottle shapes differ by comb?
anova(fit.shape.comb)
```

### Allometry

```{r c.allom.h1, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# regscore (Drake and Klingenberg 2008)

# general allometry - does dalton shape change with size?
anova(fit.size)

# comb
plotAllometry(fit.sz.ccomb,
              size = gdf$size,
              logsz = TRUE,
              method = "RegScore", 
              pch = pch.gps.comb, 
              col = col.gps.comb)

# common allometric component (Mitteroecker 2004)

# comb
plotAllometry(fit.sz.ccomb, 
              size = gdf$size, 
              logsz = TRUE, 
              method = "CAC", 
              pch = pch.gps.comb, 
              col = col.gps.comb)

# size-shape pca (Mitteroecker 2004)

# comb
plotAllometry(fit.sz.ccomb, 
              size = gdf$size, 
              logsz = TRUE, 
              method = "size.shape", 
              pch = pch.gps.comb, 
              col = col.gps.comb)
```

```{r u.allom.h1, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
## predline (Adams and Nistri 2010)

# comb
plotAllometry(fit.sz.ucomb, 
              size = gdf$size, 
              logsz = TRUE, 
              method = "PredLine", 
              pch = pch.gps.comb, 
              col = col.gps.comb)
```

### Morphological disparity

```{r m-disparity.h1, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# morphological disparity: does one group display greater 
# shape variation among individuals relative to the other group?
morphol.disparity(shape ~ comb, 
                  groups = qdata$comb, 
                  data = gdf, 
                  print.progress = FALSE, 
                  iter = 9999)
```

### Mean Shapes

```{r mshape.h1, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# subset landmark coordinates to produce mean shapes
new.coords<-coords.subset(A = Y.gpa$coords, 
                          group = qdata$comb)
names(new.coords)

# group shape means
mean <- lapply(new.coords, mshape)

# plot mean shapes
plot(mean$`north, formative early`)
plot(mean$`north, late historic`)
plot(mean$`south, formative early`)
plot(mean$`south, late historic`)

# comparison plots
plotRefToTarget(mean$`north, formative early`, 
                mean$`south, formative early`, 
                method = "vector",
                mag = 1)

##knitr::include_graphics('images/mshape.jpg')
```

## Morphological integration

```{r morph.integ, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# morphological integration::
land.gps<-c("A","A","A","A","A","B","B","B","B","B","B","B","B","B","C","C","C","C","C","C","C","C","C",
            "D","D","D","D","D","D","D","D","D","C","C","C","C","C","C","C","C",
            "C","B","B","B","B","B","B","B","B","B","A","A","A","A","A")
IT<-integration.test(Y.gpa$coords, partition.gp = land.gps, iter = 999, print.progress = FALSE)

# two.b.pls plots for integration tests::

## partition into groups A,B,C,D
A<-Y.gpa$coords[which(land.gps=='A'),,] # rim
B<-Y.gpa$coords[which(land.gps=='B'),,] # neck
C<-Y.gpa$coords[which(land.gps=='C'),,] # body
D<-Y.gpa$coords[which(land.gps=='D'),,] # base

AB.int<-integration.test(A=A,A2=B, print.progress = FALSE) # rim/neck integration
summary(AB.int)
plot(AB.int)

AC.int<-integration.test(A=A,A2=C, print.progress = FALSE) # rim/body integration
summary(AC.int)
plot(AC.int)

AD.int<-integration.test(A=A,A2=D, print.progress = FALSE) # rim/base integration
summary(AD.int)
plot(AD.int)

BC.int<-integration.test(A=B,A2=C, print.progress = FALSE) # neck/body integration
summary(BC.int)
plot(BC.int)

BD.int<-integration.test(A=B,A2=D, print.progress = FALSE) # neck/base integration
summary(BD.int)
plot(BD.int)

CD.int<-integration.test(A=C,A2=D, print.progress = FALSE) # body/base integration
summary(CD.int)
plot(CD.int)

compare.pls(AB.int,AC.int,AD.int,BC.int,BD.int,CD.int) #test integration of traits listed above
```

## Trajectory analysis

```{r trajectory, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# phenotypic trajectory analysis::
TA <- trajectory.analysis(fit, 
                          groups = qdata$geo, 
                          traj.pts = qdata$time, 
                          print.progress = FALSE)

# magnitude difference
summary(TA, attribute = "MD")

# plot
TP <- plot(TA, 
           pch = as.numeric(qdata$geo), 
           bg = as.numeric(qdata$time),
           cex = 0.7, 
           col = "gray")
add.trajectories(TP, traj.pch = c(21, 22), 
                 start.bg = 1, 
                 end.bg = 2)
```