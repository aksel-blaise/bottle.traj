# Rim morphology

## Load packages + data

```{r load.data.rim, echo = TRUE}
# load packages
# devtools::install_github("combmorphR/combmorph", ref = "Stable", build_vignettes = TRUE)
library(here)
library(geomorph)
library(tidyverse)
library(wesanderson)

# read GM data
source('readmulti.csv.R')
setwd("./data")
filelist <- list.files(pattern = ".csv")
coords <- readmulti.csv(filelist)
setwd("../")

# read qualitative data
qdata <- read.csv("qdata.csv", 
                  header = TRUE, 
                  row.names = 1)
qdata <- qdata[match(dimnames(coords)[[3]],
                     rownames(qdata)),]
```

## Generalised Procrustes Analysis

Landmark data were aligned to a global coordinate system [@RN11622;@RN11623;@RN11563], achieved through generalised Procrustes superimposition [@RN478] performed in R 4.0.3 [@R] using the `geomorph` library v. 3.3.2 [@RN11530;@RN1774]. Procrustes superimposition translates, scales, and rotates the coordinate data to allow for comparisons among objects [@RN11564;@RN478]. The `geomorph` package uses a partial Procrustes superimposition that projects the aligned specimens into tangent space subsequent to alignment in preparation for the use of multivariate methods that assume linear space [@RN1646;@RN11563]. 

```{r gpa.rim, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
#select landmarks from coords
x <- c(1:6,50:55)

# new coords
bot.rim <- coords[x,,]

# gpa
Y.gpa <- gpagen(bot.rim, 
                PrinAxes = TRUE, 
                ProcD = TRUE, 
                Proj = TRUE, 
                print.progress = FALSE)

# geomorph data frame
gdf <- geomorph.data.frame(shape = Y.gpa$coords, 
                           size = Y.gpa$Csize,
                           geo = qdata$geo,
                           time = qdata$time,
                           comb = qdata$comb)

# render 3d gpa plot
#plot(Y.gpa)

# gpa plot
#knitr::include_graphics('images/gpa3d.png')

# add rim centroid size to qdata
qdata$csz <- Y.gpa$Csize

# print updated qdata with rim centroid size
knitr::kable(qdata, 
             align = "lccccc", 
             caption = "Modified attributes included in qdata.")
```

### Boxplot

```{r box1.rim, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE, fig.cap = "Boxplot of centroid size by spatial/temporal unit."}
# attributes for boxplot
csz <- qdata$csz # centroid size
comb <-  qdata$comb # comb + time

# boxplot of Caddo bottle centroid size by comb (north/south)
csz.comb <- ggplot(qdata, aes(x = comb, y = csz, color = comb)) + 
  geom_boxplot() +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 0.3) +
  scale_colour_manual(values = wes_palette("Moonrise2")) +
  theme(legend.position = "none") +
  labs(x = 'North/South + Formative/Early or Late/Historic?', y = 'Rim Centroid Size')

# render plot
csz.comb
```

## Principal Components Analysis

Principal components analysis [@RN1746] was used to visualise rim shape variation. The shape changes described by each principal axis are commonly visualised using thin-plate spline warping of a reference 3D mesh [@RN1731;@RN479]. 

```{r pca.rim, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# principal components analysis
pca<-gm.prcomp(Y.gpa$coords)
summary(pca)

# set plot parameters
pch.gps.comb <- c(15:18)[as.factor(comb)]
col.gps.comb <- wes_palette("Moonrise2")[as.factor(comb)]
col.hull <- c("#C27D38","#798E87","#29211F","#CCC591")

# plot pca by comb
pc.plot <- plot(pca, 
                 asp = 1,
                 pch = pch.gps.comb,
                 col = col.gps.comb)
                    shapeHulls(pc.plot, 
                             groups = comb,
                             group.cols = col.hull)
```

```{r pca.warp.rim, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE, fig.cap="Results of PCA summarising shape variation in the aggregated sample; gray, north-formative/early; orange, north-late/historic; brown, south-formative/early; and black, south-late/historic; with mean shapes (gray) contrasted with max/min shapes (black)."}
# pca warp                   
#knitr::include_graphics('images/pca-warp.jpg')
```


## Define models

A residual randomisation permutation procedure (RRPP; n = 10,000 permutations) was used for all Procrustes ANOVAs [@RN1655;@RN11775], which has higher statistical power and a greater ability to identify patterns in the data should they be present [@RN1719]. To assess whether shape changes differ by group (geography and time), Procrustes ANOVAs [@RN1749] were also run that enlist effect-sizes (zscores) computed as standard deviates of the generated sampling distributions [@RN1756].

### Size and shape

```{r def.mod.1.rim, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# size
fit.sz.geo <- procD.lm(size ~ geo,
                data = gdf,
                print.progress = FALSE,
                iter = 9999)

# size
fit.sz.time <- procD.lm(size ~ time,
                data = gdf,
                print.progress = FALSE,
                iter = 9999)

# shape
fit.sh.geo <- procD.lm(shape ~ geo,
                data = gdf,
                print.progress = FALSE,
                iter = 9999)

# shape
fit.sh.time <- procD.lm(shape ~ time,
                data = gdf,
                print.progress = FALSE,
                iter = 9999)

# size.geo
fit.size <- procD.lm(size ~ geo * time,
                data = gdf,
                print.progress = FALSE,
                iter = 9999)

# shape.geo
fit.shape <- procD.lm(shape ~ geo * time,
                data = gdf,
                print.progress = FALSE,
                iter = 9999)
```

## Test Hypothesis

_Hypothesis: The rim of Formative/Early and Late/Historic Caddo bottles found north and south of the shape boundary express unique patterns of shape change._

### Procrustes ANOVA

```{r h1.rim, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# ANOVA: do Caddo bottle rim sizes differ by geo?
anova(fit.sz.geo)

# ANOVA: do Caddo bottle rim sizes differ by time?
anova(fit.sz.time)

# ANOVA: do Caddo bottle rim shapes differ by geo?
anova(fit.sh.geo)

# ANOVA: do Caddo bottle rim shapes differ by time?
anova(fit.sh.time)

# ANOVA: do Caddo bottle rim sizes differ by geo + time?
anova(fit.size)

# ANOVA: do Caddo bottle rim shapes differ by geo + time?
anova(fit.shape)
```

### Mean Shapes

```{r mshape.h1.rim, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# subset landmark coordinates to produce mean shapes
new.coords<-coords.subset(A = Y.gpa$coords, 
                          group = qdata$comb)
names(new.coords)

# group shape means
mean <- lapply(new.coords, mshape)

# plot mean shapes
plot(mean$`north, formative early`)
plot(mean$`north, late historic`)
plot(mean$`south, formative early`)
plot(mean$`south, late historic`)

# comparison plots
plotRefToTarget(mean$`north, formative early`, 
                mean$`north, late historic`, 
                method = c("points"),
                mag = 1)

plotRefToTarget(mean$`north, formative early`, 
                mean$`south, formative early`, 
                method = "points",
                mag = 1)

plotRefToTarget(mean$`north, formative early`, 
                mean$`south, late historic`, 
                method = "points",
                mag = 1)

plotRefToTarget(mean$`north, late historic`, 
                mean$`south, formative early`, 
                method = "points",
                mag = 1)

plotRefToTarget(mean$`north, late historic`, 
                mean$`south, late historic`, 
                method = "points",
                mag = 1)

plotRefToTarget(mean$`south, formative early`, 
                mean$`south, late historic`, 
                method = "points",
                mag = 1)

#knitr::include_graphics('images/comp.composite.jpg')
```
